# 検量線作成ツール（cal_curve）

分光光度計の測定値から、**検量線（線形回帰）**をブラウザだけで作成できる単一HTMLアプリです。  
ブランク補正、散布図＋回帰直線、**逆算（吸光度→濃度）**、回帰パラメータの不確かさ（標準誤差・95%信頼区間）、**外れ値指標（Studentized 残差・Cook’s 距離）**、および**Excel（.xlsx）出力**をサポートします。

---
## 特長
- **入力柔軟性**  
  - 濃度は `0.1`、`1.2E-4`、`1.2*10^-4`、`10^-4`、`E-04` などで入力可能  
  - スマホ縦画面でも使いやすいレスポンシブUI
- **ブランク補正**  
  - 指定行をブランクとして差し引き  
  - **加減算の有効数字規則**（小数点以下桁数）に従い丸め  
  - 補正後に 0 以下になった吸光度は 0 として扱い、注記を自動表示
- **回帰 & グラフ**  
  - 最小二乗法（切片あり）  
  - 散布図＋回帰直線（オレンジ点線）  
  - y 軸最小値は常に 0、回帰直線の横幅は**全測定濃度の最小～最大**で固定  
  - グラフ上/リストのチェックで任意点を**除外/再包含**して即時再計算
- **統計量**  
  - 傾き a、切片 b、決定係数 R²  
  - **SE(a), SE(b), 95%CI**、RMSE s、自由度（n−2）
- **外れ値ヒント**  
  - **Studentized 残差** |rᵢ| > 3  
  - **Cook’s 距離** Dᵢ > 4/n を候補として表示（非破壊・参考表示）
- **逆算モード（A → [X]）**  
  - 画面に出ている検量線で吸光度 A から濃度を推定（単位は横軸と同じ）
- **Excel 出力（.xlsx）**  
  - 入力表（含む/除外フラグ）、回帰パラメータ、各点の残差・Studentized・Cook の一覧  
  - グラフ画像（PNG）を貼り付けたシートを同梱

---
## 使い方
1. `cal_curve.html` をブラウザで開く（ダブルクリックでOK）。  
   - もしくは GitHub Pages で `index.html` として公開してアクセス。
2. 「基本情報」を入力し、**入力表を作成**を押す。  
3. 濃度・吸光度を入力。必要に応じて**ブランク補正**を適用。  
4. **検量線を作成**を押す。  
   - 回帰式、R²、SE/95%CI、外れ値候補が表示され、散布図と回帰直線が描画されます。  
   - グラフや右パネルで点のチェックを外すと、**即座に再計算**されます。
5. 逆算（A→濃度）：吸光度 A を入力して**計算**を押す。  
6. **Excel出力（.xlsx）**で結果を保存。

---
## ファイル構成と依存ライブラリ

- 単一ファイル：`cal_curve.html`（本ツール）
- CDN から読み込むライブラリ  
  - [Chart.js]：散布図と回帰直線の描画  
  - [jStat]：t 分布の臨界値などの統計関数  
  - [ExcelJS]：Excel ファイルの生成

> ネットに接続できない環境で使う場合は、CDNをオフラインに持ち込むか、ローカル配置に変更してください。

---
## 数式と計算メモ

- **線形回帰（切片あり）**  
  - x̄, ȳ：各平均、Sxx=Σ(x−x̄)²、Sxy=Σ(x−x̄)(y−ȳ)  
  - 傾き：a = Sxy / Sxx  
  - 切片：b = ȳ − a x̄  
  - 残差：eᵢ = yᵢ − (a xᵢ + b)  
  - SSE=Σeᵢ²、自由度 dof=n−2、MSE=s²=SSE/dof、RMSE s=√MSE  
  - R² = 1 − SSE / Σ(y−ȳ)²
- **標準誤差と95%信頼区間**  
  - SE(a)=√(s² / Sxx)  
  - SE(b)=√(s² (1/n + x̄²/Sxx))  
  - 95%CI(a)=[a±t\*SE(a)]、95%CI(b)=[b±t\*SE(b)]（t は自由度 dof の両側 95% 臨界値）
- **外れ値指標**（参考）  
  - レバレッジ hᵢ = 1/n + (xᵢ−x̄)² / Sxx  
  - **Studentized 残差** rᵢ = eᵢ / ( s √(1−hᵢ) )  
  - **Cook’s 距離** Dᵢ = (eᵢ² / (p s²)) · ( hᵢ / (1−hᵢ)² )（p=2：a と b）  
  - ヒューリスティック閾値：|rᵢ|>3、Dᵢ>4/n  
  - **注**：これは「候補表示」です。必ずしも除外を推奨するものではありません。実験条件・装置・前処理に照らして判断してください。

---
## ブランク補正と有効数字

- ブランク行の吸光度を用いて各行から差し引き  
- **加減算は小数点以下桁数**をそろえる規則に基づいて丸め  
- 補正後が 0 未満の場合は 0 とする（表下に注記を自動表示）

---
## GitHub Pages での公開

1. リポジトリを作成して `cal_curve.html` を追加（または `index.html` にリネーム）。  
2. GitHub の **Settings → Pages** でブランチ（例：`main`）と `/root` を選択して保存。  
3. 数分後、表示される URL にアクセスして動作確認。

---
## よくある質問（FAQ）

- **Q. 逆算の単位は？**  
  A. 横軸（濃度）の単位表記と同じです。  
- **Q. R² が 1.0 に見えるときの表示は？**  
  A. 9 が連続する限り表示し、9 以外が出たところを含む下 2 桁まで表示します（表示上の丸め誤認を避けるため）。  
- **Q. 回帰直線の描画範囲は？**  
  A. 常に**全測定濃度の最小～最大**に固定（除外ON/OFFしても横幅は不変）。  
- **Q. Excel には何が入る？**  
  A. 入力表（含/除外フラグ）、回帰パラメータ、各点の残差・Studentized・Cook、グラフ画像を含む複数シートを出力します。

---
## 既知の制限・注意
- 本ツールは**単回帰（一次式）**のみ対応。原点固定回帰や重み付き回帰が必要な場合は拡張が必要です。  
- 外れ値指標は目安であり、実験知見を優先してください。  
- ブラウザ・端末によっては、非常に大きいデータ件数や高解像度画像の Excel 埋め込みで保存に時間がかかることがあります。

---
## 謝辞 / 引用
- Chart.js（チャート描画）  
- jStat（統計関数）  
- ExcelJS（Excel 生成）

---
## 変更履歴（抜粋）
- v1.1: 逆算（A→濃度）、SE/95%CI、外れ値候補表示、Excel 出力を追加  
- v1.0: ブランク補正、有効数字対応、散布図＋回帰直線、点の除外/再包含、R² 特別表示
